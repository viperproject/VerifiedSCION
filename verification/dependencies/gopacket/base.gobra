// Copyright 2012 Google, Inc. All rights reserved.
//
// Use of this source code is governed by a BSD-style license
// that can be found in the LICENSE file in the root of the source
// tree.

// +gobra

package gopacket

type Layer interface {
	pred LayerMem()
	pred PayloadMem()

	decreases
	pure LayerType() LayerType

	requires LayerMem()
	ensures acc(res)
	ensures acc(res) --* LayerMem()
	decreases
	LayerContents() (res []byte)

	requires PayloadMem()
	ensures acc(res)
	ensures acc(res) --* PayloadMem()
	decreases
	LayerPayload() (res []byte)
}

type Payload []byte

pred (p Payload) Mem() { acc(p) }

decreases
pure func (p Payload) LayerType() LayerType { return LayerTypePayload() }

requires acc(p)
ensures acc(res)
ensures acc(res) --* acc(p)
decreases
func (p Payload) LayerContents() (res []byte) {
	res = []byte(p)
	assert forall i int :: 0 <= i && i < len(p) ==> acc(&p[i])
	package acc(res) --* acc(p)
}

decreases
func (p Payload) LayerPayload() []byte { return nil }

requires acc(p)
ensures acc(res)
ensures acc(res) --* acc(p)
decreases
func (p Payload) Payload() (res []byte) {
	res = []byte(p)
	assert forall i int :: 0 <= i && i < len(p) ==> acc(&p[i])
	package acc(res) --* acc(p)
}

type LinkLayer interface {
	pred LayerMem()
	pred PayloadMem()

	decreases
	pure LayerType() LayerType

	requires LayerMem()
	ensures acc(res)
	ensures acc(res) --* LayerMem()
	decreases
	LayerContents() (res []byte)

	requires PayloadMem()
	ensures acc(res)
	ensures acc(res) --* PayloadMem()
	decreases
	LayerPayload() (res []byte)

	preserves LayerMem() && PayloadMem()
	decreases
	LinkFlow() Flow
}

type NetworkLayer interface {
	pred LayerMem()
	pred PayloadMem()

	decreases
	pure LayerType() LayerType

	requires LayerMem()
	ensures acc(res)
	ensures acc(res) --* LayerMem()
	decreases
	LayerContents() (res []byte)

	requires PayloadMem()
	ensures acc(res)
	ensures acc(res) --* PayloadMem()
	decreases
	LayerPayload() (res []byte)

	preserves LayerMem() && PayloadMem()
	decreases
	NetworkFlow() Flow
}

type TransportLayer interface {
	pred LayerMem()
	pred PayloadMem()

	decreases
	pure LayerType() LayerType

	requires LayerMem()
	ensures acc(res)
	ensures acc(res) --* LayerMem()
	decreases
	LayerContents() (res []byte)

	requires PayloadMem()
	ensures acc(res)
	ensures acc(res) --* PayloadMem()
	decreases
	LayerPayload() (res []byte)

	preserves LayerMem() && PayloadMem()
	decreases
	TransportFlow() Flow
}

type ApplicationLayer interface {
	pred LayerMem()
	pred PayloadMem()

	decreases
	pure LayerType() LayerType

	requires LayerMem()
	ensures acc(res)
	ensures acc(res) --* LayerMem()
	decreases
	LayerContents() (res []byte)

	requires PayloadMem()
	ensures acc(res)
	ensures acc(res) --* PayloadMem()
	decreases
	LayerPayload() (res []byte)

	preserves LayerMem() && PayloadMem()
	decreases
	Payload() []byte
}

type ErrorLayer interface {
	Layer

	preserves LayerMem() && PayloadMem()
	decreases
	Error() error
}
